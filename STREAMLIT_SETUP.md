# Streamlit Cloud Deployment Setup

## ğŸš€ Quick Setup

1. **Use the lightweight requirements file** - Create/edit `requirements.txt` for Streamlit:
   ```
   # Copy contents from requirements-streamlit.txt
   # This avoids torch/heavy ML dependencies that cause compatibility issues
   ```

2. **Configure secrets** (see below)

---

## âš ï¸ Common Issue: App Shows Wrong Data

If your Streamlit app is showing posts that don't match your Neon database, it means the `DATABASE_URL` secret is **not configured correctly** in Streamlit Cloud.

### Quick Check

Look at the sidebar of your deployed app:
- âœ… **"Connected to Neon"** = Correct configuration
- âš ï¸ **"No DATABASE_URL configured"** or **"Using local SQLite"** = Needs fixing

## Solution: Configure Neon Database URL in Streamlit Secrets

### Step 1: Get Your Neon Database URL

1. Go to [Neon Console](https://console.neon.tech)
2. Select your project
3. Click on **"Connection Details"**
4. Copy the connection string (it looks like this):
   ```
   postgresql://user:password@ep-xxx-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require
   ```

### Step 2: Add to Streamlit Cloud Secrets

1. Go to your Streamlit Cloud dashboard: https://share.streamlit.io
2. Click on your app (**Trump Post Predictor**)
3. Click the **"..."** menu â†’ **"Settings"**
4. Click **"Secrets"** in the left sidebar
5. Add the following in the secrets text box:

```toml
DATABASE_URL = "postgresql://your-user:your-password@ep-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require"

# Optional: For content generation
ANTHROPIC_API_KEY = "sk-ant-api03-..."

# Optional: For real-time news context
NEWS_API_KEY = "your_newsapi_key"
```

6. Click **"Save"**
7. Your app will automatically restart with the new configuration

### Step 3: Verify It Works

After saving secrets and app restart:
1. Refresh the app page
2. Check the sidebar - should show **"âœ… Connected to Neon"**
3. Go to **"âš™ï¸ About"** page for detailed database status
4. Posts shown should match what's in your Neon database

## Fixing "App Shows Wrong Posts" Issue

If posts in Streamlit don't match Neon database:

1. **Verify DATABASE_URL is correct:**
   - The URL must start with `postgresql://`
   - Must include `?sslmode=require` at the end
   - Check for typos in username/password

2. **Clear Streamlit cache:**
   - Go to Settings â†’ Clear Cache
   - Or add `?cache_bust=1` to your app URL

3. **Restart the app:**
   - Settings â†’ Reboot app

4. **Verify data exists in Neon:**
   - Connect to Neon via psql or their web console
   - Run: `SELECT COUNT(*) FROM posts;`
   - If 0, your data collection cron jobs need to run first

## Alternative: Use Environment Variables (Not Recommended)

You can also set environment variables in Streamlit Cloud, but **secrets are preferred** because:
- They're encrypted
- They don't show up in logs
- They're easier to manage

## Troubleshooting

### Error: `torch.utils._pytree has no attribute 'register_pytree_node'`
This is a PyTorch version compatibility issue. The dashboard should NOT need torch.
- Make sure you're using `requirements-streamlit.txt` (lightweight, no torch)
- The dashboard is for viewing data; predictions are generated by Render cron jobs

### Error: "Connection refused"
- Check that your Neon database is running (not suspended)
- Verify the connection string is correct
- Make sure `sslmode=require` is in the URL

### Error: "Database doesn't exist" or "relation does not exist"
- The database tables may not be initialized yet
- The app now auto-initializes tables on startup
- If it still fails, run the data collection cron job on Render first

### Error: "ProgrammingError" on CronRunLog
- The `cron_run_log` table doesn't exist yet
- This is normal for a fresh deployment
- Tables are created when the first cron job runs on Render

### Posts count shows 0 or very few posts
- Data collection cron jobs on Render need to be running
- Check Render dashboard for cron job status/errors

### "Make Prediction" button doesn't work
- This is expected on Streamlit Cloud
- Predictions require heavy ML dependencies (PyTorch, Prophet)
- **Predictions are generated automatically by the Render cron jobs**
- View predictions on the Dashboard page

### Still seeing local SQLite data?
- Clear your Streamlit Cloud cache (Settings â†’ Clear Cache)
- Verify the secrets were saved (check for typos)
- Restart the app manually (Settings â†’ Reboot app)
- Check that the key is exactly `DATABASE_URL` (case-sensitive)

## Architecture Note

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Streamlit Cloud    â”‚     â”‚    Render.com       â”‚
â”‚  (Dashboard Only)   â”‚     â”‚   (ML Workloads)    â”‚
â”‚                     â”‚     â”‚                     â”‚
â”‚  - View posts       â”‚     â”‚  - Collect data     â”‚
â”‚  - View predictions â”‚â—„â”€â”€â”€â–ºâ”‚  - Generate preds   â”‚
â”‚  - View metrics     â”‚     â”‚  - Retrain models   â”‚
â”‚                     â”‚     â”‚  - Validate preds   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Neon DB      â”‚
              â”‚  (PostgreSQL) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Need Help?

Check the [Streamlit Cloud Secrets documentation](https://docs.streamlit.io/streamlit-community-cloud/deploy-your-app/secrets-management)
